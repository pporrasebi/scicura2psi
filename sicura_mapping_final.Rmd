---
title: "Scicura mappings"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,eval = TRUE)
```

## Synopsis

This is an attempt to generate a map of Scicura plain text file export to a format we can use to generate a PSI-MI XML file to import into IntAct and generate a proper MITAB through that. 

#### Libraries
```{r libraries, warning=FALSE,message=FALSE}
library(data.table)
library(readxl)
library(dplyr)
library(splitstackshape)
library(BridgeDbR)
```

## Import required files
I start by importing the Scicura database contents.
```{r upload}
# Import Scicura database
scicura_db <- data.table(read_excel("./scicura_files/scicura_annotation.xlsx",
                         sheet = "plain_example",
                         col_names = T,
                         col_types = "guess"),
                         check.names = T,
                         stringsAsFactors=FALSE)
```

## Mapping

I go field by field checking what can be mapped from the Scicura format to MITAB. Rules have been defined by Astrid, Sandra and me and are imported from appropriate files as needed.

##### 0: preformatting
Only entries with valid identifiers for the TG/TF fields are considered. I also reformat scicura IDs so they do not have the extra '1000' at the beginning of the value. 
```{r preformat}
scicura_db_id <- scicura_db[TF.ID!="" & TG.ID!="",
                            .(vsmID,
                            origVsmID,
                            Template.ID,
                            Date,
                            First.Curator,
                            MLAok,
                            ALok,
                            LTok,
                            MKok,
                            STok,
                            TF.Gene.Name,
                            TF.Name,
                            TF.Database,
                            TF.ID,
                            TF.SC.ID = gsub("^1000","",TF.SC.ID),
                            TF.Representation,
                            TF.Repr.SC.ID = gsub("^1000","",TF.Repr.SC.ID),
                            TG.Name,
                            TG.DB,
                            TG.ID,
                            TG.SC.ID = gsub("^1000","",TG.SC.ID),
                            TG.Representation,
                            TG.Repr.SC.ID = gsub("^1000","",TG.Repr.SC.ID),
                            GO.Term,
                            GO.ID,
                            Exp.Method,
                            Exp.Method.SC.ID = gsub("^1000","",Exp.Method.SC.ID),
                            Pub.Elem,
                            Cell.Line,
                            Cell.Line.ID,
                            Cell.Line.SC.ID = gsub("^1000","",Cell.Line.SC.ID),
                            PubMed.ID,
                            All.Curators,
                            Comments,
                            TF2.Gene.Name,
                            TF2.Name,
                            TF2.Database,
                            TF2.ID,
                            TF2.SC.ID = gsub("^1000","",TF2.SC.ID),
                            TF2.Representation,
                            TF2.Repr.SC.ID = gsub("^1000","",TF2.Repr.SC.ID),
                            TF3.Gene.Name,
                            TF3.Name,
                            TF3.Database,
                            TF3.ID,
                            TF3.SC.ID = gsub("^1000","",TF3.SC.ID),
                            TF3.Representation,
                            TF3.Repr.SC.ID = gsub("^1000","",TF3.Repr.SC.ID),
                            TF4.Gene.Name,
                            TF4.Name,
                            TF4.Database,
                            TF4.ID,
                            TF4.SC.ID = gsub("^1000","",TF4.SC.ID),
                            TF4.Representation,
                            TF4.Repr.SC.ID = gsub("^1000","",TF4.Repr.SC.ID))]
```

##### 1: Mapping interaction detection method
All methods were mapped in the 'experiments.xlsx' file. The Scicura experimental method 'reporter gene assay' (SCI:206987) could not be mapped to any interaction detection method and has been mapped to 'unspecified method' (MI:0686). 
```{r map_idm}
# Import rules
sci2psi <- data.table(read_excel("./scicura_files/experiments.xlsx",
                                 sheet = "Sheet1",
                                 col_names = T,
                                 col_types = "text"),
                                 check.names = T,
                                 stringsAsFactors=F)

sci2psi_simple <- sci2psi[,.(termID,
                             termName,
                             MI_code)]

# Mapping
map_sci_1 <- unique(merge(scicura_db_id,
                          sci2psi_simple,
                          by.x = "Exp.Method.SC.ID",
                          by.y = "termID",
                          all.x = T,
                          all.y = F))
setnames(map_sci_1,c("termName","MI_code"),c("exp_met_name","exp_met_mi"))
```

###### 1.1 Discarding non-interaction detection methods
Some terms used as interaction detection methods by the Scicura team are actually NOT valid interaction detection methods and need to be discarded or re-mapped. On an email exchange with Astrid Laegrid (10-11/03/2020). Terms to discard are: 

    1. northern blot (MI:0929)
    2. partial DNA sequence identification by hybridization (MI:0080)
    3. reporter gene assay (MI:0686)
    
Additionally, 'primer specific pcr' (MI:0088) needs to be re-mapped to 'ch-ip' (MI:0402).
```{r idm.discard.remap}
methods.discard <- c("northern blot",
                     "partial DNA sequence identification by hybridization",
                     "reporter gene assay")
map_sci_1.1 <- map_sci_1[!(exp_met_name %in% methods.discard)]

# Replace primer specific pcr with chip

map_sci_1.1[exp_met_name == "primer specific pcr"]$exp_met_name <- "ch-ip"
map_sci_1.1[exp_met_mi == "MI:0088"]$exp_met_mi <- "MI:0402"
```

##### 2: Add participant detection methods
This is taken from the mapping sheet 'Int. methods vs part. methods ' in the 'rules_ppm.xlsx'. 
```{r add_part_det_met}
# Import rules
idm2pdm <- data.table(read_excel("./scicura_files/rules_ppm.xlsx",
                                 sheet = "Int. methods vs part. methods ",
                                 col_names = T,
                                 col_types = "text"),
                                 stringsAsFactors=F,
                      check.names = T)

idm2pdm_simple <- idm2pdm[,.(intdetmet_mi,
                             partdetmet_A,
                             partdetmet_mi_A,
                             partdetmet_B,
                             partdetmet_mi_B)]

# Mapping
map_sci_2 <- unique(merge(map_sci_1.1,
                          idm2pdm_simple,
                          by.x = "exp_met_mi",
                          by.y = "intdetmet_mi",
                          all.x = T,
                          all.y = F))
```

##### 3: Add host organism for interaction
There might be conflicts between the cell line stated in the 'cell line' field on original scicura file and the predetermined host for each of the interaction detection methods given in the 'rules_ppm.xlsx' file. I need to reconcile both. 
```{r host}
# Import rules
# For method
idm2hostorg <- data.table(read_excel("./scicura_files/rules_ppm.xlsx",
                                 sheet = "int. methods vs host organism",
                                 col_names = T,
                                 col_types = "text"),
                                 stringsAsFactors=F,
                          check.names = T)

idm2hostorg_simple <- idm2hostorg[,.(idm_mi = gsub('".*','',gsub(".*MI:","MI:",Interaction.detection.method)),
                                     host = ifelse(grepl("-1",Host.organism),
                                                   "-1",
                                                   ""))]

# For cell line
scihost2intacthost <- data.table(read_excel("./scicura_files/rules_ppm.xlsx",
                                 sheet = "Scicura vs Intact host org.",
                                 col_names = T,
                                 col_types = "text"),
                                 stringsAsFactors=F,
                          check.names = T)

# intact_host_mis <- fread("./scicura_files/intact_organisms.txt",
#                          header=T,
#                          colClasses = "character",
#                          stringsAsFactors = F,
#                          sep = "\t")
# 
intact_host_mis <- fread("./scicura_files/intact_organisms_full.txt",
                         header=T,
                         colClasses = "character",
                         stringsAsFactors = F,
                         sep = "\t")

scihost2intacthost_info <- unique(merge(scihost2intacthost,
                                intact_host_mis,
                                by.x = "IntAct.mitab",
                                by.y = "SHORTLABEL",
                                all.x = T,
                                all.y = F))

# Some cell lines stated to be available in Intact actually need to be created. 

# scihost2intacthost_tocreate <- scihost2intacthost_info[is.na(AC)|CELLTYPE_AC==""]
scihost2intacthost_tocreate <- scihost2intacthost_info[is.na(AC)]

fwrite(scihost2intacthost_tocreate, 
       "./processed_files/scihost2intacthost_tocreate.txt",
       col.names = T,
       row.names = F,
       sep = "\t",
       quote = F)

scihost2intacthost_simple <- scihost2intacthost_info[!is.na(AC),.(scicura_host,
                                                   intact_tissue_ac = TISSUE_AC,
                                                   intact_ct_ac = CELLTYPE_AC,
                                                   intact_host_taxid = TAXID)]

# Mapping
# Map by method first
map_sci_3 <- unique(merge(map_sci_2,
                          idm2hostorg_simple,
                          by.x = "exp_met_mi",
                          by.y = "idm_mi",
                          all.x = F,
                          all.y = F))

# Map using cell line now
map_sci_4 <- unique(merge(map_sci_3,
                          scihost2intacthost_simple,
                          by.x = "Cell.Line",
                          by.y = "scicura_host",
                          all.x = T,
                          all.y = F))

# Detect conflicts and missing values
map_sci_4 <- map_sci_4[,host_check := ifelse(host=="-1" & intact_host_taxid == "-1" | 
                                                     host=="-1" & is.na(intact_host_taxid),
                                             "ok, take host",
                                             ifelse(host=="" & (!is.na(intact_tissue_ac)|!is.na(intact_ct_ac)),
                                                    "ok, take intact_host",
                                                    ifelse(host=="" & (is.na(intact_tissue_ac) & is.na(intact_ct_ac)),
                                                           "non-mappable",
                                                           ifelse(host=="-1" & (!is.na(intact_tissue_ac)|!is.na(intact_ct_ac)),
                                                                  "conflict, take intact_host",
                                                                  "check"))))]

table(map_sci_4$host_check,useNA = "ifany")
```
There are 85 non-mappable cases, plus 23 cases where Scicura curators specified a cell line but the specific interaction detection method used suggests the experiment may have been performed *in vitro*. The non-mappable cases will not be included in this import test and in the ones with conflict we will take the cell line as host organism. 

```{r host_checker}
map_sci_4 <- data.table(mutate(map_sci_4, 
                               host_taxid = 
                                       ifelse(host_check == "ok, take host",
                                              host,
                                              ifelse(host_check == "ok, take intact_host" |
                                                             host_check == "conflict, take intact_host",
                                                     intact_host_taxid,
                                                     NA)),
                               tissue_ac = 
                                       ifelse(host_check == "ok, take host",
                                              "",
                                              ifelse(host_check == "ok, take intact_host" |
                                                             host_check == "conflict, take intact_host",
                                                     intact_tissue_ac,
                                                     NA)),
                               ct_ac = 
                                       ifelse(host_check == "ok, take host",
                                              "",
                                              ifelse(host_check == "ok, take intact_host" |
                                                             host_check == "conflict, take intact_host",
                                                     intact_ct_ac,
                                                     NA))))
table(map_sci_4$host_check,useNA = "ifany")
```

##### 4: Bringing in the participant type
Participant type is always protein for TFs and different types of nucleic acid-related terms for the TG. The TG type can be inferred from the interaction detection methods, as given by the 'int. methods vs int. type B' in the 'rules_ppm.xlsx' file. 
```{r part_type}
# Import rules
idm2irtypepb <- data.table(read_excel("./scicura_files/rules_ppm.xlsx",
                                 sheet = "int. methods vs int. type B",
                                 col_names = T,
                                 col_types = "text"),
                                 stringsAsFactors=F,
                          check.names = T)

idm2irtypepb_simple <- idm2irtypepb[,.(idm_mi = gsub('".*','',gsub(".*MI:","MI:",Interaction.detection.method)),
                                       pB_type = gsub("\\)","",gsub(".*\\(","",Interactor.type.B)),
                                       pB_type_mi = gsub('".*','',gsub(".*MI:","MI:",Interactor.type.B)))]

# Mapping
map_sci_5 <- unique(merge(map_sci_4[host_check!="non-mappable"],
                          idm2irtypepb_simple,
                          by.x = "exp_met_mi",
                          by.y = "idm_mi",
                          all.x = T,
                          all.y = F))
map_sci_5 <- data.table(mutate(map_sci_5,
                               pA1_type = "protein",
                               pA1_type_mi = "MI:0326",
                               pA2_type = ifelse(TF2.Name!="",
                                                 "protein",
                                                 ""),
                               pA2_type_mi = ifelse(TF2.Name!="",
                                                 "MI:0326",
                                                 ""),
                               pA3_type = ifelse(TF3.Name!="",
                                                 "protein",
                                                 ""),
                               pA3_type_mi = ifelse(TF3.Name!="",
                                                 "MI:0326",
                                                 ""),
                               pA4_type = ifelse(TF4.Name!="",
                                                 "protein",
                                                 ""),
                               pA4_type_mi = ifelse(TF4.Name!="",
                                                 "MI:0326",
                                                 "")))
```

##### 5: Bringing in predetermined features depending on interaction detection method or TF representation annotation
Some methods force certain features to be present in the TG field and TF features can be mapped using the TF representation ID. I import these from the sheets 'tf repr. vs feature int. A' and 'int. methods vs feature int. B' in the 'rules_ppm.xlsx' file. 

```{r feat_import}
# Import rules
# For TGs
idm2featpb <- data.table(read_excel("./scicura_files/rules_ppm.xlsx",
                                 sheet = "int. methods vs feature int. B",
                                 col_names = T,
                                 col_types = "text"),
                                 stringsAsFactors=F,
                          check.names = T)

idm2featpb_simple <- idm2featpb[,.(idm_mi = intdetmet_mi,
                                   feattype_B,
                                   feattype_mi_B)]

# For TFs
tfterm2feat <- data.table(read_excel("./scicura_files/rules_ppm.xlsx",
                                 sheet = "tf repr. vs feature int. A",
                                 col_names = T,
                                 col_types = "text"),
                                 stringsAsFactors=F,
                          check.names = T)

tfterm2feat_simple <- tfterm2feat[,.(termID,
                                    feattype_A,
                                    feattype_mi_A)]

# Mapping
# TG features
map_sci_6 <- unique(merge(map_sci_5,
                          idm2featpb_simple,
                          by.x = "exp_met_mi",
                          by.y = "idm_mi",
                          all.x = T,
                          all.y = F))

# TF features
map_sci_7 <- unique(merge(map_sci_6,
                          tfterm2feat_simple,
                          by.x = "TF.Repr.SC.ID",
                          by.y = "termID",
                          all.x = T,
                          all.y = F))

map_sci_8 <- unique(merge(map_sci_7,
                          tfterm2feat_simple,
                          by.x = "TF2.Repr.SC.ID",
                          by.y = "termID",
                          all.x = T,
                          all.y = F))

setnames(map_sci_8,
         c("feattype_A.x","feattype_mi_A.x","feattype_A.y","feattype_mi_A.y"),
         c("feattype_A1","feattype_mi_A1","feattype_A2","feattype_mi_A2"))

map_sci_9 <- unique(merge(map_sci_8,
                          tfterm2feat_simple,
                          by.x = "TF3.Repr.SC.ID",
                          by.y = "termID",
                          all.x = T,
                          all.y = F))

map_sci_10 <- unique(merge(map_sci_9,
                          tfterm2feat_simple,
                          by.x = "TF4.Repr.SC.ID",
                          by.y = "termID",
                          all.x = T,
                          all.y = F))

setnames(map_sci_10,
         c("feattype_A.x","feattype_mi_A.x","feattype_A.y","feattype_mi_A.y"),
         c("feattype_A3","feattype_mi_A3","feattype_A4","feattype_mi_A4"))
```

##### 6: Mapping the TF description
This is probably the most complicated field to map, since it opens up several different fields to be populated in the MITAB format. This is taken from the 'TF-representation_comparison.xlsx' file. 

Once imported, information needs proper clean-up. 
```{r map_tf_descr}
# Import rules
tf_repr <- data.table(read_excel("./scicura_files/TF_representation_comparison.xlsx",
                                 sheet = "sheet1",
                                 col_names = T,
                                 col_types = "text"),
                                 stringsAsFactors=F,
                          check.names = T)

tf_repr_sel <- tf_repr[,.(termID,
                             exp_preps = exp_prep_ppm,
                             participant_host,
                             xref_ac = gsub(".*\\(","",gsub("\\)","",xref)),
                             xref_db = ifelse(xref!="",
                                              "GO",
                                              ""),
                             xref_db_mi = ifelse(xref!="",
                                              "MI:0448",
                                              ""),
                             features)]

tf_repr_sel_org <- unique(merge(tf_repr_sel,
                                intact_host_mis,
                                by.x = "participant_host",
                                by.y = "SHORTLABEL",
                                all.x = T,
                                all.y = F))

tf_repr_sel_org <- data.table(mutate(tf_repr_sel_org,
                                     TAXID = ifelse(!is.na(TAXID),
                                                    TAXID,
                                                    ifelse(participant_host=="bacteria*",
                                                           "2",
                                                           ifelse(participant_host=="mammalia*",
                                                                  "40674",
                                                                  ifelse(participant_host=="sf9/sf21/high-5*",
                                                                         "50557",
                                                                         "")))),
                                     AC = ifelse(!is.na(AC),
                                                    AC,
                                                    ""),
                                     phost_shtlbl = ifelse(grepl("\\*",participant_host),
                                                          "",
                                                          participant_host)))
tf_repr_sel_long <- cSplit(tf_repr_sel_org,
                           "exp_preps",
                           sep = ",",
                           direction = "long",
                           drop = F)

tf_repr_sel_singles <- tf_repr_sel_org[!grepl(",",exp_preps)]
tf_repr_sel_long_full <- rbind(tf_repr_sel_long,
                               tf_repr_sel_singles)

tf_repr_sel_long_full <- data.table(mutate(tf_repr_sel_long_full,
                                      exp_prep_shtlbl = gsub(" \\(.*|\\(.*","",exp_preps),
                                      exp_prep_mi = gsub(".*\\(","",gsub("\\)","",exp_preps))))

tf_repr_sel_long2 <- cSplit(tf_repr_sel_long_full, 
                            "features",
                            sep = ",",
                            direction = "long",
                            drop = T)
tf_repr_sel_singles2 <- tf_repr_sel_long_full[!grepl(",",features)]
tf_repr_sel_long2_full <- rbind(tf_repr_sel_long2,
                               tf_repr_sel_singles2)

feat_acs <- fread("./scicura_files/feat_acs.txt",
                  header= T,
                  colClasses = "character",
                  stringsAsFactors = F,
                  sep = "\t")

tf_repr_sel_info2 <- unique(merge(tf_repr_sel_long2_full,
                                  feat_acs,
                                  by.x = "features",
                                  by.y = "shtlbl",
                                  all.x = T,
                                  all.y = F))

tf_repr_simple <- tf_repr_sel_info2[,.(termID,
                                      xref_ac,
                                      xref_db,
                                      xref_db_mi,
                                      phost_shtlbl,
                                      phost_ac = AC,
                                      phost_taxid = TAXID,
                                      exp_prep_shtlbl,
                                      exp_prep_mi,
                                      featshtlbl = features,
                                      featshtlbl_mi = mi_code)]

# Mapping
map_sci_11 <- unique(merge(map_sci_10,
                          tf_repr_simple,
                          by.x = "TF.Repr.SC.ID",
                          by.y = "termID",
                          all.x = T,
                          all.y = F))

map_sci_12 <- unique(merge(map_sci_11,
                          tf_repr_simple,
                          by.x = "TF2.Repr.SC.ID",
                          by.y = "termID",
                          all.x = T,
                          all.y = F))

setnames(map_sci_12,
         c("xref_ac.x","xref_db.x","xref_db_mi.x","phost_shtlbl.x","phost_ac.x","phost_taxid.x","exp_prep_shtlbl.x","exp_prep_mi.x","featshtlbl.x","featshtlbl_mi.x","xref_ac.y","xref_db.y","xref_db_mi.y","phost_shtlbl.y","phost_ac.y","phost_taxid.y","exp_prep_shtlbl.y","exp_prep_mi.y","featshtlbl.y","featshtlbl_mi.y"),
         c("xref_ac_tf1","xref_db_tf1","xref_db_mi_tf1","phost_shtlbl_tf1","phost_ac_tf1","phost_taxid_tf1","exp_prep_shtlbl_tf1","exp_prep_mi_tf1","featshtlbl_tf1","featshtlbl_mi_tf1","xref_ac_tf2","xref_db_tf2","xref_db_mi_tf2","phost_shtlbl_tf2","phost_ac_tf2","phost_taxid_tf2","exp_prep_shtlbl_tf2","exp_prep_mi_tf2","featshtlbl_tf2","featshtlbl_mi_tf2"))

map_sci_13 <- unique(merge(map_sci_12,
                          tf_repr_simple,
                          by.x = "TF3.Repr.SC.ID",
                          by.y = "termID",
                          all.x = T,
                          all.y = F))

map_sci_14 <- unique(merge(map_sci_13,
                          tf_repr_simple,
                          by.x = "TF4.Repr.SC.ID",
                          by.y = "termID",
                          all.x = T,
                          all.y = F))

setnames(map_sci_14,
         c("xref_ac.x","xref_db.x","xref_db_mi.x","phost_shtlbl.x","phost_ac.x","phost_taxid.x","exp_prep_shtlbl.x","exp_prep_mi.x","featshtlbl.x","featshtlbl_mi.x","xref_ac.y","xref_db.y","xref_db_mi.y","phost_shtlbl.y","phost_ac.y","phost_taxid.y","exp_prep_shtlbl.y","exp_prep_mi.y","featshtlbl.y","featshtlbl_mi.y"),
         c("xref_ac_tf3","xref_db_tf3","xref_db_mi_tf3","phost_shtlbl_tf3","phost_ac_tf3","phost_taxid_tf3","exp_prep_shtlbl_tf3","exp_prep_mi_tf3","featshtlbl_tf3","featshtlbl_mi_tf3","xref_ac_tf4","xref_db_tf4","xref_db_mi_tf4","phost_shtlbl_tf4","phost_ac_tf4","phost_taxid_tf4","exp_prep_shtlbl_tf4","exp_prep_mi_tf4","featshtlbl_tf4","featshtlbl_mi_tf4"))
```

##### 7: Mapping the TG description
This is taken from the 'TG_dictionary_SO_150917.xlsx' file. Will be mapped as xrefs to SO. 
```{r tg_map}
# Import rules
tg_repr2so <- data.table(read_excel("./scicura_files/TG_dictionary_SO_150917.xlsx",
                                 sheet = "Sheet1",
                                 col_names = T,
                                 col_types = "text"),
                                 stringsAsFactors=F,
                          check.names = T)

tg_repr2so_simple <- tg_repr2so[,.(termID,
                                   so_type_xref = gsub(".*\\(","",gsub("\\)","",SO.type)),
                                   so_type_db = ifelse(SO.type!="",
                                                       "so",
                                                       ""),
                                   so_type_db_mi = ifelse(SO.type!="",
                                                          "MI:0601",
                                                          ""),
                                   so_region_xref = gsub(".*\\(","",gsub("\\)","",SO.region)),
                                   so_region_db = ifelse(SO.region!="",
                                                       "so",
                                                       ""),
                                   so_region_db_mi = ifelse(SO.region!="",
                                                          "MI:0601",
                                                          ""))]

# Mapping
map_sci_15 <- unique(merge(map_sci_14,
                           tg_repr2so_simple,
                           by.x = "TG.Repr.SC.ID",
                           by.y = "termID",
                           all.x = T,
                           all.y = F))

tg_nonrepr <- unique(map_sci_15[is.na(so_type_xref),.(TG.Repr.SC.ID,
                                         TG.Representation)])
```
It seems there are some TG representation values that are not mappable to the SO, as listed in this table: `r tg_nonrepr`


##### 8: Mapping Entrez IDs to ENSEMBL

TGs are currently mapped to NCBI Entrez, but they need to be re-mapped to ENSEMBL for import. I do that using BridgeDBR. There is a mix of human, mouse and rat identifiers in the TG participants, but the species is not provided, so I will need to run the mapping several times. 

```{r entrez_map,message=FALSE}
# tg_entrez_map <- unique(map_sci_15[,.(TG.ID,
#                                       TG_ensembl = "")])
# 
# # Round 1 mapping
# location <- getDatabase("Homo sapiens")
# mapper <- loadDatabase(location)
# 
# for (i in 1:nrow(tg_entrez_map)){
#         tg_entrez_map[i,]$TG_ensembl <- paste(map(mapper, "L", tg_entrez_map[i,]$TG.ID, "En"),collapse=";")
# }
# 
# tg_entrez_map <- data.table(mutate(tg_entrez_map,
#                                    tg_taxid =
#                                            ifelse(TG_ensembl=="",
#                                                   "10090",
#                                                   "9606")))
# # Round 2 mapping
# location2 <- getDatabase("Mus musculus")
# mapper2 <- loadDatabase(location2)
# 
# for (i in 1:nrow(tg_entrez_map[tg_taxid=="10090"])){
#         tg_entrez_map[tg_taxid=="10090"][i,]$TG_ensembl <- paste(map(mapper2, "L", tg_entrez_map[tg_taxid=="10090"][i,]$TG.ID, "En"),collapse=";")
# }
# 
# tg_entrez_map <- data.table(mutate(tg_entrez_map,
#                                    tg_taxid =
#                                            ifelse(TG_ensembl=="",
#                                                   "10116",
#                                                   tg_taxid)))
# 
# # Round 3 mapping
# location3 <- getDatabase("Rattus norvegicus")
# mapper3 <- loadDatabase(location3)
# 
# for (i in 1:nrow(tg_entrez_map[tg_taxid=="10116"])){
#         tg_entrez_map[tg_taxid=="10116"][i,]$TG_ensembl <- paste(map(mapper3, "L", tg_entrez_map[tg_taxid=="10116"][i,]$TG.ID, "En"),collapse=";")
# }
# 
# # Entries not mapped are checked in Entrez and the correct species is given
# tg_entrez_map <- data.table(mutate(tg_entrez_map,
#                                    tg_taxid =
#                                            ifelse(TG.ID=="111519",
#                                                   "10090",
#                                                   ifelse(TG.ID=="3492",
#                                                          "9606",
#                                                          tg_taxid)),
#                                    tg_ensembl_db = ifelse(TG_ensembl!="",
#                                                           "ensembl",
#                                                           ""),
#                                    tg_ensembl_db_mi = ifelse(TG_ensembl!="",
#                                                           "MI:0476",
#                                                           "")))
# 
# # Save tg_entrez_map so the above part does not have to be run again if there are problems with BridgeDBR
# 
# fwrite(
#         tg_entrez_map,
#         "./processed_files/tg_entrez_map.txt",
#         col.names = T,
#         row.names = F,
#         sep = "\t",
#         quote = F
# )

tg_entrez_map <- fread(
        "./processed_files/tg_entrez_map.txt",
        header = T,
        check.names = T,
        sep = "\t"
)

# Mapping to data

# map_sci_15$TG.ID <- as.character(map_sci_15$TG.ID)
map_sci_16 <- unique(merge(map_sci_15,
                           tg_entrez_map,
                           by = "TG.ID",
                           all.x = T,
                           all.y = F))
```

##### 9: Obtaining taxids for TFs

It seems the TFs do not provide species information either. I obtain that from UniProt.
```{r up_info}
# Obtain organism information
tf_ids <- unique(rbind(unique(map_sci_16[,.(id = TF.ID)]),
                unique(map_sci_16[,.(id = TF2.ID)]),
                unique(map_sci_16[,.(id = TF3.ID)]),
                unique(map_sci_16[,.(id = TF4.ID)])))
tf_ids <- tf_ids[id!=""]
fwrite(tf_ids,
       "./processed_files/tf_ids.txt",
       col.names = F,
       row.names = F,
       sep = "\t",
       quote = F)

# system("perl ./scripts/up_query.pl ./processed_files/tf_ids.txt > ./processed_files/tf_ids_org.txt")

tf_ids_org <- fread("./processed_files/tf_ids_org.txt",
                    header=F,
                    colClasses = "character",
                    stringsAsFactors = F)

# Mapping
map_sci_17 <- unique(merge(map_sci_16,
                           tf_ids_org,
                           by.x = "TF.ID",
                           by.y = "V1",
                           all.x = T,
                           all.y = F))

map_sci_18 <- unique(merge(map_sci_17,
                           tf_ids_org,
                           by.x = "TF2.ID",
                           by.y = "V1",
                           all.x = T,
                           all.y = F))

setnames(map_sci_18,
         c("V2.x","V2.y"),
         c("tf_taxid","tf2_taxid"))

map_sci_19 <- unique(merge(map_sci_18,
                           tf_ids_org,
                           by.x = "TF3.ID",
                           by.y = "V1",
                           all.x = T,
                           all.y = F))

map_sci_20 <- unique(merge(map_sci_19,
                           tf_ids_org,
                           by.x = "TF4.ID",
                           by.y = "V1",
                           all.x = T,
                           all.y = F))

setnames(map_sci_20,
         c("V2.x","V2.y"),
         c("tf3_taxid","tf4_taxid"))
```
## Re-formatting and production of flatfile

Now I generate a flatfile that is usable for xml maker. Many formatting steps are needed before the flatfile can be generated. 
```{r preflatfile}
preflatfile1 <- map_sci_20[,.(psimi = "psi-mi",
			psi_mi_mi = "MI:0488",
			identity = "identity",
			identity_mi = "MI:0356",
			comment_publ = All.Curators,
			comment_publ_type = "comment",
			comment_publ_type_mi = "MI:0612",
			xref_exp1 = Exp.Method.SC.ID,
			xref_exp1_db = "ntnu",
			xref_exp1_db_mi = "MI:1264",
			xref_exp2 = Cell.Line.SC.ID,
			xref_exp2_db = "ntnu",
			xref_exp2_db_mi = "MI:1264",
			xref_exp3 = Cell.Line.ID,
			xref_exp3_db = ifelse(Cell.Line.ID!="",
			                      "brenda",
			                      ""),
			xref_exp3_db_mi = ifelse(Cell.Line.ID!="",
			                      "MI:0864",
			                      ""),
			pmid = PubMed.ID,
			pubmed_ref = "pubmed",
			pubmed_ref_mi = "MI:0446",
			primary_ref = "primary-reference",
			primary_ref_mi = "MI:0358",
			host_taxid = host_taxid,
			tissue_ac = tissue_ac,
			ct_ac = ct_ac,
			int_det_met = Exp.Method,
			int_det_met_mi = exp_met_mi,
			fig_leg = Pub.Elem,
			fig_leg_type = ifelse(Pub.Elem!="",
			                      "figure legend",
			                      ""),
			fig_leg_type_mi = ifelse(Pub.Elem!="",
			                      "MI:0599",
			                      ""),
			xref_int1 = paste("vsmID: ",vsmID,sep=""),
			xref_int1_db = "ntnu",
			xref_int1_db_mi = "MI:1264",
			xref_int2 = paste("origVsmID: ",origVsmID,sep=""),
			xref_int2_db = "ntnu",
			xref_int2_db_mi = "MI:1264",
			xref_int3 = GO.ID,
			xref_int3_db = "go",
			xref_int3_db_mi = "MI:0448",
			comment_int1 = Template.ID,
			comment_int1_type = "comment",
			comment_int1_type_mi = "MI:0612",
			comment_int2 = Date,
			comment_int2_type = "comment",
			comment_int2_type_mi = "MI:0612",
			comment_int3 = First.Curator,
			comment_int3_type = "comment",
			comment_int3_type_mi = "MI:0612",
			comment_int4 = Comments,
			comment_int4_type = "remark-internal",
			comment_int4_type_mi = "IA:0245",
			part1_alias = TF.Gene.Name,
			part1_alias_type = "gene name",
			part1_alias_type_mi = "MI:0301",
			part1_id = TF.ID,
			part1_id_db = TF.Database,
			part1_id_db_mi = "MI:0486",
			part1_xref_ac = xref_ac_tf1,
			part1_xref_db = xref_db_tf1,
			part1_xref_db_mi = xref_db_mi_tf1,
			part1_xref2_ac = "",
			part1_xref2_db = "",
			part1_xref2_db_mi = "",
			part1_xref3 = "",
			part1_xref3_db = "",
			part1_xref3_db_mi = "",
			part1_scixref = TF.SC.ID,
			part1_scixref_db = "ntnu",
			part1_scixref_db_mi = "MI:1264",
			part1_scixref2 = TF.Repr.SC.ID,
			part1_scixref2_db = "ntnu",
			part1_scixref2_db_mi = "MI:1264",
			part1_comment1 = TF.Representation,
			part1_comment1_type = "comment",
			part1_comment1_type_mi = "MI:0612",
			part1_taxid = tf_taxid,
			part1_type = pA1_type,
			part1_type_mi = pA1_type_mi,
			part1_pdm = partdetmet_A,
			part1_pdm_mi = partdetmet_mi_A,
			part1_tissue_ac = phost_shtlbl_tf1,
			part1_ct_ac = phost_ac_tf1,
			part1_phost_db = ifelse(phost_shtlbl_tf1!="",
			                        "intact",
			                        ""),
			part1_phost_dbmi = ifelse(phost_shtlbl_tf1!="",
			                        "MI:0469",
			                        ""),
			part1_phost_taxid = phost_taxid_tf1,
			part1_exp_prep_shtlbl = exp_prep_shtlbl_tf1,
			part1_exp_prep_mi = exp_prep_mi_tf1,
			part1_feat1_shortlabel = ifelse(feattype_A1!="",
			                                "feature",
			                                ""),
			part1_feat1_type = feattype_A1,
			part1_feat1_type_mi = feattype_mi_A1,
			part1_feat1_range = ifelse(feattype_A1!="",
			                                "undetermined",
			                                ""),
			part1_feat1_range_mi = ifelse(feattype_A1!="",
			                                "MI:0339",
			                                ""),
			part1_feat2_shortlabel = ifelse(featshtlbl_tf1!="",
			                                "feature",
			                                ""),
			part1_feat2_type = featshtlbl_tf1,
			part1_feat2_type_mi = featshtlbl_mi_tf1,
			part1_feat2_range = ifelse(featshtlbl_tf1!="",
			                                "undetermined",
			                                ""),
			part1_feat2_range_mi = ifelse(featshtlbl_tf1!="",
			                                "MI:0339",
			                                ""),
			part2_alias = TG.Name,
			part2_alias_type = "gene name",
			part2_alias_type_mi = "MI:0301",
			part2_id = TG_ensembl,
			part2_id_db = tg_ensembl_db,
			part2_id_db_mi = tg_ensembl_db_mi,
			part2_xref1 = TG.ID,
			part2_xref1_db = "entrezgene/locuslink",
			part2_xref1_db_mi = "MI:0477",
			part2_xref2 = so_type_xref,
			part2_xref2_db = so_type_db,
			part2_xref2_db_mi = so_type_db_mi,
			part2_xref3 = so_region_xref,
			part2_xref3_db = so_region_db,
			part2_xref3_db_mi = so_region_db_mi,
			part2_scixref = TG.SC.ID,
			part2_scixref_db = "ntnu",
			part2_scixref_db_mi = "MI:1264",
			part2_scixref2 = TG.Repr.SC.ID,
			part2_scixref2_db = "ntnu",
			part2_scixref2_db_mi = "MI:1264",
			part2_comment1 = TG.Representation,
			part2_comment1_type = "comment",
			part2_comment1_type_mi = "MI:0612",
			part2_taxid = tg_taxid,
			part2_type = pB_type,
			part2_type_mi = pB_type_mi,
			part2_pdm = partdetmet_B,
			part2_pdm_mi = partdetmet_mi_B,
			part2_tissue_ac = "",
			part2_ct_ac = "",
			part2_phost_db = "",
			part2_phost_dbmi = "",
			part2_phost_taxid = "",
			part2_exp_prep_shtlbl = "",
			part2_exp_prep_mi = "",
			part2_feat1_shortlabel = ifelse(feattype_B!="",
			                                "feature",
			                                ""),
			part2_feat1_type = feattype_B,
			part2_feat1_type_mi = feattype_mi_B,
			part2_feat1_range = ifelse(feattype_B!="",
			                                "undetermined",
			                                ""),
			part2_feat1_range_mi = ifelse(feattype_B!="",
			                                "MI:0339",
			                                ""),
			part2_feat2_shortlabel = "",
			part2_feat2_type = "",
			part2_feat2_type_mi = "",
			part2_feat2_range = "",
			part2_feat2_range_mi = "",
			part3_alias = TF2.Gene.Name,
			part3_alias_type = ifelse(TF2.Gene.Name!="",
			                          "gene name",
			                          ""),
			part3_alias_type_mi = ifelse(TF2.Gene.Name!="",
			                          "MI:0301",
			                          ""),
			part3_id = TF2.ID,
			part3_id_db = TF2.Database,
			part3_id_db_mi = ifelse(TF2.Database!="",
			                        "MI:0486",
			                        ""),
			part3_xref_ac = xref_ac_tf2,
			part3_xref_db = xref_db_tf2,
			part3_xref_db_mi = xref_db_mi_tf2,
			part3_xref2_ac = "",
			part3_xref2_db = "",
			part3_xref2_db_mi = "",
			part3_xref3 = "",
			part3_xref3_db = "",
			part3_xref3_db_mi = "",
			part3_scixref = TF2.SC.ID,
			part3_scixref_db = ifelse(TF2.SC.ID!="",
			                          "ntnu",
			                          ""),
			part3_scixref_db_mi = ifelse(TF2.SC.ID!="",
			                          "MI:1264",
			                          ""),
			part3_scixref2 = TF2.Repr.SC.ID,
			part3_scixref2_db = ifelse(TF2.Repr.SC.ID!="",
			                          "ntnu",
			                          ""),
			part3_scixref2_db_mi = ifelse(TF2.Repr.SC.ID!="",
			                          "MI:1264",
			                          ""),
			part3_comment1 = TF2.Representation,
			part3_comment1_type = ifelse(TF2.Representation!="",
			                             "comment",
			                             ""),
			part3_comment1_type_mi = ifelse(TF2.Representation!="",
			                             "MI:0612",
			                             ""),
			part3_taxid = tf2_taxid,
			part3_type = pA2_type,
			part3_type_mi = pA2_type_mi,
			part3_pdm = ifelse(pA2_type_mi!="",
			                   partdetmet_A,
			                   ""),
			part3_pdm_mi = ifelse(pA2_type_mi!="",
			                   partdetmet_mi_A,
			                   ""),
			part3_tissue_ac = phost_shtlbl_tf2,
			part3_ct_ac = phost_ac_tf2,
			part3_phost_db = ifelse(phost_shtlbl_tf2!="",
			                        "intact",
			                        ""),
			part3_phost_dbmi = ifelse(phost_shtlbl_tf2!="",
			                        "MI:0469",
			                        ""),
			part3_phost_taxid = phost_taxid_tf2,
			part3_exp_prep_shtlbl = exp_prep_shtlbl_tf2,
			part3_exp_prep_mi = exp_prep_mi_tf2,
			part3_feat1_shortlabel = ifelse(feattype_A2!="",
			                                "feature",
			                                ""),
			part3_feat1_type = feattype_A2,
			part3_feat1_type_mi = feattype_mi_A2,
			part3_feat1_range = ifelse(feattype_A2!="",
			                                "undetermined",
			                                ""),
			part3_feat1_range_mi = ifelse(feattype_A2!="",
			                                "MI:0339",
			                                ""),
			part3_feat2_shortlabel = ifelse(featshtlbl_tf2!="",
			                                "feature",
			                                ""),
			part3_feat2_type = featshtlbl_tf2,
			part3_feat2_type_mi = featshtlbl_mi_tf2,
			part3_feat2_range = ifelse(featshtlbl_tf2!="",
			                                "undetermined",
			                                ""),
			part3_feat2_range_mi = ifelse(featshtlbl_tf2!="",
			                                "MI:0339",
			                                ""),
			part4_alias = TF3.Gene.Name,
			part4_alias_type = ifelse(TF3.Gene.Name!="",
			                          "gene name",
			                          ""),
			part4_alias_type_mi = ifelse(TF3.Gene.Name!="",
			                          "MI:0301",
			                          ""),
			part4_id = TF3.ID,
			part4_id_db = TF3.Database,
			part4_id_db_mi = ifelse(TF3.Database!="",
			                        "MI:0486",
			                        ""),
			part4_xref_ac = xref_ac_tf3,
			part4_xref_db = xref_db_tf3,
			part4_xref_db_mi = xref_db_mi_tf3,
			part4_xref2_ac = "",
			part4_xref2_db = "",
			part4_xref2_db_mi = "",
			part4_xref3 = "",
			part4_xref3_db = "",
			part4_xref3_db_mi = "",
			part4_scixref = TF3.SC.ID,
			part4_scixref_db = ifelse(TF3.SC.ID!="",
			                          "ntnu",
			                          ""),
			part4_scixref_db_mi = ifelse(TF3.SC.ID!="",
			                          "MI:1264",
			                          ""),
			part4_scixref2 = TF3.Repr.SC.ID,
			part4_scixref2_db = ifelse(TF3.Repr.SC.ID!="",
			                          "ntnu",
			                          ""),
			part4_scixref2_db_mi = ifelse(TF3.Repr.SC.ID!="",
			                          "MI:1264",
			                          ""),
			part4_comment1 = TF3.Representation,
			part4_comment1_type = ifelse(TF3.Representation!="",
			                             "comment",
			                             ""),
			part4_comment1_type_mi = ifelse(TF3.Representation!="",
			                             "MI:0612",
			                             ""),
			part4_taxid = tf3_taxid,
			part4_type = pA2_type,
			part4_type_mi = pA2_type_mi,
			part4_pdm = ifelse(pA2_type_mi!="",
			                   partdetmet_A,
			                   ""),
			part4_pdm_mi = ifelse(pA2_type_mi!="",
			                   partdetmet_mi_A,
			                   ""),
			part4_tissue_ac = phost_shtlbl_tf3,
			part4_ct_ac = phost_ac_tf3,
			part4_phost_db = ifelse(phost_shtlbl_tf3!="",
			                        "intact",
			                        ""),
			part4_phost_dbmi = ifelse(phost_shtlbl_tf3!="",
			                        "MI:0469",
			                        ""),
			part4_phost_taxid = phost_taxid_tf3,
			part4_exp_prep_shtlbl = exp_prep_shtlbl_tf3,
			part4_exp_prep_mi = exp_prep_mi_tf3,
			part4_feat1_shortlabel = ifelse(feattype_A3!="",
			                                "feature",
			                                ""),
			part4_feat1_type = feattype_A3,
			part4_feat1_type_mi = feattype_mi_A3,
			part4_feat1_range = ifelse(feattype_A3!="",
			                                "undetermined",
			                                ""),
			part4_feat1_range_mi = ifelse(feattype_A3!="",
			                                "MI:0339",
			                                ""),
			part4_feat2_shortlabel = ifelse(featshtlbl_tf3!="",
			                                "feature",
			                                ""),
			part4_feat2_type = featshtlbl_tf3,
			part4_feat2_type_mi = featshtlbl_mi_tf3,
			part4_feat2_range = ifelse(featshtlbl_tf3!="",
			                                "undetermined",
			                                ""),
			part4_feat2_range_mi = ifelse(featshtlbl_tf3!="",
			                                "MI:0339",
			                                ""),
			part5_alias = TF4.Gene.Name,
			part5_alias_type = ifelse(TF4.Gene.Name!="",
			                          "gene name",
			                          ""),
			part5_alias_type_mi = ifelse(TF4.Gene.Name!="",
			                          "MI:0301",
			                          ""),
			part5_id = TF4.ID,
			part5_id_db = TF4.Database,
			part5_id_db_mi = ifelse(TF4.Database!="",
			                        "MI:0486",
			                        ""),
			part5_xref_ac = xref_ac_tf4,
			part5_xref_db = xref_db_tf4,
			part5_xref_db_mi = xref_db_mi_tf4,
			part5_xref2_ac = "",
			part5_xref2_db = "",
			part5_xref2_db_mi = "",
			part5_xref3 = "",
			part5_xref3_db = "",
			part5_xref3_db_mi = "",
			part5_scixref = TF4.SC.ID,
			part5_scixref_db = ifelse(TF4.SC.ID!="",
			                          "ntnu",
			                          ""),
			part5_scixref_db_mi = ifelse(TF4.SC.ID!="",
			                          "MI:1264",
			                          ""),
			part5_scixref2 = TF4.Repr.SC.ID,
			part5_scixref2_db = ifelse(TF4.Repr.SC.ID!="",
			                          "ntnu",
			                          ""),
			part5_scixref2_db_mi = ifelse(TF4.Repr.SC.ID!="",
			                          "MI:1264",
			                          ""),
			part5_comment1 = TF4.Representation,
			part5_comment1_type = ifelse(TF4.Representation!="",
			                             "comment",
			                             ""),
			part5_comment1_type_mi = ifelse(TF4.Representation!="",
			                             "MI:0612",
			                             ""),
			part5_taxid = tf4_taxid,
			part5_type = pA2_type,
			part5_type_mi = pA2_type_mi,
			part5_pdm = ifelse(pA2_type_mi!="",
			                   partdetmet_A,
			                   ""),
			part5_pdm_mi = ifelse(pA2_type_mi!="",
			                   partdetmet_mi_A,
			                   ""),
			part5_tissue_ac = phost_shtlbl_tf4,
			part5_ct_ac = phost_ac_tf4,
			part5_phost_db = ifelse(phost_shtlbl_tf4!="",
			                        "intact",
			                        ""),
			part5_phost_dbmi = ifelse(phost_shtlbl_tf4!="",
			                        "MI:0469",
			                        ""),
			part5_phost_taxid = phost_taxid_tf4,
			part5_exp_prep_shtlbl = exp_prep_shtlbl_tf4,
			part5_exp_prep_mi = exp_prep_mi_tf4,
			part5_feat1_shortlabel = ifelse(feattype_A4!="",
			                                "feature",
			                                ""),
			part5_feat1_type = feattype_A4,
			part5_feat1_type_mi = feattype_mi_A4,
			part5_feat1_range = ifelse(feattype_A4!="",
			                                "undetermined",
			                                ""),
			part5_feat1_range_mi = ifelse(feattype_A4!="",
			                                "MI:0339",
			                                ""),
			part5_feat2_shortlabel = ifelse(featshtlbl_tf4!="",
			                                "feature",
			                                ""),
			part5_feat2_type = featshtlbl_tf4,
			part5_feat2_type_mi = featshtlbl_mi_tf4,
			part5_feat2_range = ifelse(featshtlbl_tf4!="",
			                                "undetermined",
			                                ""),
			part5_feat2_range_mi = ifelse(featshtlbl_tf4!="",
			                                "MI:0339",
			                                ""),
			Date)]

for (col in colnames(preflatfile1)) preflatfile1[is.na(get(col)), (col) := ""]

preflatfile2 <- unique(preflatfile1[,
                             .(psimi,
		psi_mi_mi,
		identity,
		identity_mi,
		comment_publ,
		comment_publ_type,
		comment_publ_type_mi,
		xref_exp1,
		xref_exp1_db,
		xref_exp1_db_mi,
		xref_exp2,
		xref_exp2_db,
		xref_exp2_db_mi,
		xref_exp3,
		xref_exp3_db,
		xref_exp3_db_mi,
		pmid,
		pubmed_ref,
		pubmed_ref_mi,
		primary_ref,
		primary_ref_mi,
		host_taxid,
		tissue_ac,
		ct_ac,
		int_det_met,
		int_det_met_mi,
		fig_leg,
		fig_leg_type,
		fig_leg_type_mi,
		xref_int1,
		xref_int1_db,
		xref_int1_db_mi,
		xref_int2,
		xref_int2_db,
		xref_int2_db_mi,
		xref_int3,
		xref_int3_db,
		xref_int3_db_mi,
		comment_int1,
		comment_int1_type,
		comment_int1_type_mi,
		comment_int2,
		comment_int2_type,
		comment_int2_type_mi,
		comment_int3,
		comment_int3_type,
		comment_int3_type_mi,
		comment_int4,
		comment_int4_type,
		comment_int4_type_mi,
		part1_alias,
		part1_alias_type,
		part1_alias_type_mi,
		part1_id,
		part1_id_db,
		part1_id_db_mi,
		part1_xref_ac,
		part1_xref_db,
		part1_xref_db_mi,
		part1_xref2_ac,
		part1_xref2_db,
		part1_xref2_db_mi,
		part1_xref3,
		part1_xref3_db,
		part1_xref3_db_mi,
		part1_scixref,
		part1_scixref_db,
		part1_scixref_db_mi,
		part1_scixref2,
		part1_scixref2_db,
		part1_scixref2_db_mi,
		part1_comment1,
		part1_comment1_type,
		part1_comment1_type_mi,
		part1_taxid,
		part1_type,
		part1_type_mi,
		part1_pdm,
		part1_pdm_mi,
		part1_tissue_ac,
		part1_ct_ac,
		part1_phost_db,
		part1_phost_dbmi,
		part1_phost_taxid,
		part1_exp_preps = ifelse(part1_exp_prep_shtlbl!="",
		                         paste(unique(paste(part1_exp_prep_shtlbl,part1_exp_prep_mi,sep="&")),collapse="|"),
		                         ""),
		part1_feat1_shortlabel,
		part1_feat1_type,
		part1_feat1_type_mi,
		part1_feat1_range,
		part1_feat1_range_mi,
		part1_feat2_shortlabel,
		part1_feat2_type,
		part1_feat2_type_mi,
		part1_feat2_range,
		part1_feat2_range_mi,
		part2_alias,
		part2_alias_type,
		part2_alias_type_mi,
		part2_id,
		part2_id_db,
		part2_id_db_mi,
		part2_xref1,
		part2_xref1_db,
		part2_xref1_db_mi,
		part2_xref2,
		part2_xref2_db,
		part2_xref2_db_mi,
		part2_xref3,
		part2_xref3_db,
		part2_xref3_db_mi,
		part2_scixref,
		part2_scixref_db,
		part2_scixref_db_mi,
		part2_scixref2,
		part2_scixref2_db,
		part2_scixref2_db_mi,
		part2_comment1,
		part2_comment1_type,
		part2_comment1_type_mi,
		part2_taxid,
		part2_type,
		part2_type_mi,
		part2_pdm,
		part2_pdm_mi,
		part2_tissue_ac,
		part2_ct_ac,
		part2_phost_db,
		part2_phost_dbmi,
		part2_phost_taxid,
		part2_exp_preps = ifelse(part2_exp_prep_shtlbl!="",
		                         paste(unique(paste(part2_exp_prep_shtlbl,part2_exp_prep_mi,sep="&")),collapse="|"),
		                         ""),
		part2_feat1_shortlabel,
		part2_feat1_type,
		part2_feat1_type_mi,
		part2_feat1_range,
		part2_feat1_range_mi,
		part2_feat2_shortlabel,
		part2_feat2_type,
		part2_feat2_type_mi,
		part2_feat2_range,
		part2_feat2_range_mi,
		part3_alias,
		part3_alias_type,
		part3_alias_type_mi,
		part3_id,
		part3_id_db,
		part3_id_db_mi,
		part3_xref_ac,
		part3_xref_db,
		part3_xref_db_mi,
		part3_xref2_ac,
		part3_xref2_db,
		part3_xref2_db_mi,
		part3_xref3,
		part3_xref3_db,
		part3_xref3_db_mi,
		part3_scixref,
		part3_scixref_db,
		part3_scixref_db_mi,
		part3_scixref2,
		part3_scixref2_db,
		part3_scixref2_db_mi,
		part3_comment1,
		part3_comment1_type,
		part3_comment1_type_mi,
		part3_taxid,
		part3_type,
		part3_type_mi,
		part3_pdm,
		part3_pdm_mi,
		part3_tissue_ac,
		part3_ct_ac,
		part3_phost_db,
		part3_phost_dbmi,
		part3_phost_taxid,
		part3_exp_preps = ifelse(part3_exp_prep_shtlbl!="",
		                         paste(unique(paste(part3_exp_prep_shtlbl,part3_exp_prep_mi,sep="&")),collapse="|"),
		                         ""),
		part3_feat1_shortlabel,
		part3_feat1_type,
		part3_feat1_type_mi,
		part3_feat1_range,
		part3_feat1_range_mi,
		part3_feat2_shortlabel,
		part3_feat2_type,
		part3_feat2_type_mi,
		part3_feat2_range,
		part3_feat2_range_mi,
		part4_alias,
		part4_alias_type,
		part4_alias_type_mi,
		part4_id,
		part4_id_db,
		part4_id_db_mi,
		part4_xref_ac,
		part4_xref_db,
		part4_xref_db_mi,
		part4_xref2_ac,
		part4_xref2_db,
		part4_xref2_db_mi,
		part4_xref3,
		part4_xref3_db,
		part4_xref3_db_mi,
		part4_scixref,
		part4_scixref_db,
		part4_scixref_db_mi,
		part4_scixref2,
		part4_scixref2_db,
		part4_scixref2_db_mi,
		part4_comment1,
		part4_comment1_type,
		part4_comment1_type_mi,
		part4_taxid,
		part4_type,
		part4_type_mi,
		part4_pdm,
		part4_pdm_mi,
		part4_tissue_ac,
		part4_ct_ac,
		part4_phost_db,
		part4_phost_dbmi,
		part4_phost_taxid,
		part4_exp_preps = ifelse(part4_exp_prep_shtlbl!="",
		                         paste(unique(paste(part4_exp_prep_shtlbl,part4_exp_prep_mi,sep="&")),collapse="|"),
		                         ""),
		part4_feat1_shortlabel,
		part4_feat1_type,
		part4_feat1_type_mi,
		part4_feat1_range,
		part4_feat1_range_mi,
		part4_feat2_shortlabel,
		part4_feat2_type,
		part4_feat2_type_mi,
		part4_feat2_range,
		part4_feat2_range_mi,
		part5_alias,
		part5_alias_type,
		part5_alias_type_mi,
		part5_id,
		part5_id_db,
		part5_id_db_mi,
		part5_xref_ac,
		part5_xref_db,
		part5_xref_db_mi,
		part5_xref2_ac,
		part5_xref2_db,
		part5_xref2_db_mi,
		part5_xref3,
		part5_xref3_db,
		part5_xref3_db_mi,
		part5_scixref,
		part5_scixref_db,
		part5_scixref_db_mi,
		part5_scixref2,
		part5_scixref2_db,
		part5_scixref2_db_mi,
		part5_comment1,
		part5_comment1_type,
		part5_comment1_type_mi,
		part5_taxid,
		part5_type,
		part5_type_mi,
		part5_pdm,
		part5_pdm_mi,
		part5_tissue_ac,
		part5_ct_ac,
		part5_phost_db,
		part5_phost_dbmi,
		part5_phost_taxid,
		part5_exp_preps = ifelse(part5_exp_prep_shtlbl!="",
		                         paste(unique(paste(part5_exp_prep_shtlbl,part5_exp_prep_mi,sep="&")),collapse="|"),
		                         ""),
		part5_feat1_shortlabel,
		part5_feat1_type,
		part5_feat1_type_mi,
		part5_feat1_range,
		part5_feat1_range_mi,
		part5_feat2_shortlabel,
		part5_feat2_type,
		part5_feat2_type_mi,
		part5_feat2_range,
		part5_feat2_range_mi,
		Date),
                             by = xref_int1])

check.prefl2 <- data.table(table(preflatfile2$xref_int1,useNA = "ifany"))

check.prefl2.2 <- preflatfile2[xref_int1 %in% check.prefl2[N==2]$V1]
fwrite(
        check.prefl2.2,
        "./processed_files/check.prefl2.2.txt",
        col.names = T,
        row.names = F,
        sep = "\t",
        quote = F
)

preflatfile3 <- preflatfile2[,.(psimi,
			psi_mi_mi,
			identity,
			identity_mi,
			comment_publ,
			comment_publ_type,
			comment_publ_type_mi,
			xref_exp1,
			xref_exp1_db,
			xref_exp1_db_mi,
			xref_exp2_col = ifelse(xref_exp2!="",
									paste(xref_exp2,xref_exp2_db,xref_exp2_db_mi,sep="&"),
									""),
			xref_exp3_col = ifelse(xref_exp3!="",
									paste(xref_exp3,xref_exp3_db,xref_exp3_db_mi,sep="&"),
									""),
			pmid,
			pubmed_ref,
			pubmed_ref_mi,
			primary_ref,
			primary_ref_mi,
			host_taxid,
			tissue_ac,
			ct_ac,
			int_det_met,
			int_det_met_mi,
			xref_int1,
			xref_int1_db,
			xref_int1_db_mi,
			xref_int2_col = ifelse(xref_int2!="",
									paste(xref_int2,xref_int2_db,xref_int2_db_mi,sep="&"),
									""),
			xref_int3_col = ifelse(xref_int3!="",
									paste(xref_int3,xref_int3_db,xref_int3_db_mi,sep="&"),
									""),
			part1_alias,
			part1_alias_type,
			part1_alias_type_mi,
			part1_id,
			part1_id_db,
			part1_id_db_mi,
			part1_xref_ac,
			part1_xref_db,
			part1_xref_db_mi,
			part1_xref2_col = ifelse(part1_xref2_ac!="",
									paste(part1_xref2_ac,part1_xref2_db,part1_xref2_db_mi,sep="&"),
									""),
			part1_xref3_col = ifelse(part1_xref3!="",
									paste(part1_xref3,part1_xref3_db,part1_xref3_db_mi,sep="&"),
									""),
			part1_scixref_col = ifelse(part1_scixref!="",
									paste(part1_scixref,part1_scixref_db,part1_scixref_db_mi,sep="&"),
									""),
			part1_scixref2_col = ifelse(part1_scixref2!="",
									paste(part1_scixref2,part1_scixref2_db,part1_scixref2_db_mi,sep="&"),
									""),
			part1_comment1,
			part1_comment1_type,
			part1_comment1_type_mi,
			part1_taxid,
			part1_type,
			part1_type_mi,
			part1_pdm,
			part1_pdm_mi,
			part1_tissue_ac,
			part1_ct_ac,
			part1_phost_db,
			part1_phost_dbmi,
			part1_phost_taxid,
			part1_exp_preps,
			part1_feat1_col = ifelse(part1_feat1_shortlabel!="",
									paste(part1_feat1_shortlabel,part1_feat1_type,part1_feat1_type_mi,part1_feat1_range,part1_feat1_range_mi,sep="&"),
									""),
			part1_feat2_col = ifelse(part1_feat2_shortlabel!="",
									paste(part1_feat2_shortlabel,part1_feat2_type,part1_feat2_type_mi,part1_feat2_range,part1_feat2_range_mi,sep="&"),
									""),
			part2_alias,
			part2_alias_type,
			part2_alias_type_mi,
			part2_id,
			part2_id_db,
			part2_id_db_mi,
			part2_xref1,
			part2_xref1_db,
			part2_xref1_db_mi,
			part2_xref2_col = ifelse(part2_xref2!="",
									paste(part2_xref2,part2_xref2_db,part2_xref2_db_mi,sep="&"),
									""),
			part2_xref3_col = ifelse(part2_xref3!="",
									paste(part2_xref3,part2_xref3_db,part2_xref3_db_mi,sep="&"),
									""),
			part2_scixref_col = ifelse(part2_scixref!="",
									paste(part2_scixref,part2_scixref_db,part2_scixref_db_mi,sep="&"),
									""),
			part2_scixref2_col = ifelse(part2_scixref2!="",
									paste(part2_scixref2,part2_scixref2_db,part2_scixref2_db_mi,sep="&"),
									""),
			part2_comment1,
			part2_comment1_type,
			part2_comment1_type_mi,
			part2_taxid,
			part2_type,
			part2_type_mi,
			part2_pdm,
			part2_pdm_mi,
			part2_tissue_ac,
			part2_ct_ac,
			part2_phost_db,
			part2_phost_dbmi,
			part2_phost_taxid,
			part2_exp_preps,
			part2_feat1_col = ifelse(part2_feat1_shortlabel!="",
									paste(part2_feat1_shortlabel,part2_feat1_type,part2_feat1_type_mi,part2_feat1_range,part2_feat1_range_mi,sep="&"),
									""),
			part2_feat2_col = ifelse(part2_feat2_shortlabel!="",
									paste(part2_feat2_shortlabel,part2_feat2_type,part2_feat2_type_mi,part2_feat2_range,part2_feat2_range_mi,sep="&"),
									""),
			part3_alias,
			part3_alias_type,
			part3_alias_type_mi,
			part3_id,
			part3_id_db,
			part3_id_db_mi,
			part3_xref_ac,
			part3_xref_db,
			part3_xref_db_mi,
			part3_xref2_col = ifelse(part3_xref2_ac!="",
									paste(part3_xref2_ac,part3_xref2_db,part3_xref2_db_mi,sep="&"),
									""),
			part3_xref3_col = ifelse(part3_xref3!="",
									paste(part3_xref3,part3_xref3_db,part3_xref3_db_mi,sep="&"),
									""),
			part3_scixref_col = ifelse(part3_scixref!="",
									paste(part3_scixref,part3_scixref_db,part3_scixref_db_mi,sep="&"),
									""),
			part3_scixref2_col = ifelse(part3_scixref2!="",
									paste(part3_scixref2,part3_scixref2_db,part3_scixref2_db_mi,sep="&"),
									""),
			part3_comment1,
			part3_comment1_type,
			part3_comment1_type_mi,
			part3_taxid,
			part3_type,
			part3_type_mi,
			part3_pdm,
			part3_pdm_mi,
			part3_tissue_ac,
			part3_ct_ac,
			part3_phost_db,
			part3_phost_dbmi,
			part3_phost_taxid,
			part3_exp_preps,
			part3_feat1_col = ifelse(part3_feat1_shortlabel!="",
									paste(part3_feat1_shortlabel,part3_feat1_type,part3_feat1_type_mi,part3_feat1_range,part3_feat1_range_mi,sep="&"),
									""),
			part3_feat2_col = ifelse(part3_feat2_shortlabel!="",
									paste(part3_feat2_shortlabel,part3_feat2_type,part3_feat2_type_mi,part3_feat2_range,part3_feat2_range_mi,sep="&"),
									""),
			part4_alias,
			part4_alias_type,
			part4_alias_type_mi,
			part4_id,
			part4_id_db,
			part4_id_db_mi,
			part4_xref_ac,
			part4_xref_db,
			part4_xref_db_mi,
			part4_xref2_col = ifelse(part4_xref2_ac!="",
									paste(part4_xref2_ac,part4_xref2_db,part4_xref2_db_mi,sep="&"),
									""),
			part4_xref3_col = ifelse(part4_xref3!="",
									paste(part4_xref3,part4_xref3_db,part4_xref3_db_mi,sep="&"),
									""),
			part4_scixref_col = ifelse(part4_scixref!="",
									paste(part4_scixref,part4_scixref_db,part4_scixref_db_mi,sep="&"),
									""),
			part4_scixref2_col = ifelse(part4_scixref2!="",
									paste(part4_scixref2,part4_scixref2_db,part4_scixref2_db_mi,sep="&"),
									""),
			part4_comment1,
			part4_comment1_type,
			part4_comment1_type_mi,
			part4_taxid,
			part4_type,
			part4_type_mi,
			part4_pdm,
			part4_pdm_mi,
			part4_tissue_ac,
			part4_ct_ac,
			part4_phost_db,
			part4_phost_dbmi,
			part4_phost_taxid,
			part4_exp_preps,
			part4_feat1_col = ifelse(part4_feat1_shortlabel!="",
									paste(part4_feat1_shortlabel,part4_feat1_type,part4_feat1_type_mi,part4_feat1_range,part4_feat1_range_mi,sep="&"),
									""),
			part4_feat2_col = ifelse(part4_feat2_shortlabel!="",
									paste(part4_feat2_shortlabel,part4_feat2_type,part4_feat2_type_mi,part4_feat2_range,part4_feat2_range_mi,sep="&"),
									""),
			part5_alias,
			part5_alias_type,
			part5_alias_type_mi,
			part5_id,
			part5_id_db,
			part5_id_db_mi,
			part5_xref_ac,
			part5_xref_db,
			part5_xref_db_mi,
			part5_xref2_col = ifelse(part5_xref2_ac!="",
									paste(part5_xref2_ac,part5_xref2_db,part5_xref2_db_mi,sep="&"),
									""),
			part5_xref3_col = ifelse(part5_xref3!="",
									paste(part5_xref3,part5_xref3_db,part5_xref3_db_mi,sep="&"),
									""),
			part5_scixref_col = ifelse(part5_scixref!="",
									paste(part5_scixref,part5_scixref_db,part5_scixref_db_mi,sep="&"),
									""),
			part5_scixref2_col = ifelse(part5_scixref2!="",
									paste(part5_scixref2,part5_scixref2_db,part5_scixref2_db_mi,sep="&"),
									""),
			part5_comment1,
			part5_comment1_type,
			part5_comment1_type_mi,
			part5_taxid,
			part5_type,
			part5_type_mi,
			part5_pdm,
			part5_pdm_mi,
			part5_tissue_ac,
			part5_ct_ac,
			part5_phost_db,
			part5_phost_dbmi,
			part5_phost_taxid,
			part5_exp_preps,
			part5_feat1_col = ifelse(part5_feat1_shortlabel!="",
									paste(part5_feat1_shortlabel,part5_feat1_type,part5_feat1_type_mi,part5_feat1_range,part5_feat1_range_mi,sep="&"),
									""),
			part5_feat2_col = ifelse(part5_feat2_shortlabel!="",
									paste(part5_feat2_shortlabel,part5_feat2_type,part5_feat2_type_mi,part5_feat2_range,part5_feat2_range_mi,sep="&"),
									""),
			fig_leg,
			fig_leg_type,
			fig_leg_type_mi,
			comment_int1,
			comment_int1_type,
			comment_int1_type_mi,
			comment_int2,
			comment_int2_type,
			comment_int2_type_mi,
			comment_int3,
			comment_int3_type,
			comment_int3_type_mi,
			comment_int4,
			comment_int4_type,
			comment_int4_type_mi,
			Date)]

preflatfile4 <- unique(preflatfile3[,.(psimi,
				psi_mi_mi,
				identity,
				identity_mi,
				comment_publ,
				comment_publ_type,
				comment_publ_type_mi,
				xref_exp1,
				xref_exp1_db,
				xref_exp1_db_mi,
				xrefs_exp = paste(xref_exp2_col,xref_exp3_col,sep="|"),
				pmid,
				pubmed_ref,
				pubmed_ref_mi,
				primary_ref,
				primary_ref_mi,
				host_taxid,
				tissue_ac,
				ct_ac,
				int_det_met,
				int_det_met_mi,
				xref_int1_db,
				xref_int1_db_mi,
				xrefs_int = paste(xref_int2_col,xref_int3_col,sep="|"),
				part1_alias,
				part1_alias_type,
				part1_alias_type_mi,
				part1_id,
				part1_id_db,
				part1_id_db_mi,
				part1_xref_ac,
				part1_xref_db,
				part1_xref_db_mi,
				part1_xrefs = paste(part1_xref2_col,part1_xref3_col,part1_scixref_col,part1_scixref2_col,sep="|"),
				part1_comment1,
				part1_comment1_type,
				part1_comment1_type_mi,
				part1_taxid,
				part1_type,
				part1_type_mi,
				part1_pdm,
				part1_pdm_mi,
				part1_tissue_ac,
				part1_ct_ac,
				part1_phost_db,
				part1_phost_dbmi,
				part1_phost_taxid,
				part1_exp_preps,
				part1_feats = paste(part1_feat1_col,paste(unique(part1_feat2_col),collapse="|"),sep="|"),
				part2_alias,
				part2_alias_type,
				part2_alias_type_mi,
				part2_id,
				part2_id_db,
				part2_id_db_mi,
				part2_xref1,
				part2_xref1_db,
				part2_xref1_db_mi,
				part2_xrefs = paste(part2_xref2_col,part2_xref3_col,part2_scixref_col,part2_scixref2_col,sep="|"),
				part2_comment1,
				part2_comment1_type,
				part2_comment1_type_mi,
				part2_taxid,
				part2_type,
				part2_type_mi,
				part2_pdm,
				part2_pdm_mi,
				part2_tissue_ac,
				part2_ct_ac,
				part2_phost_db,
				part2_phost_dbmi,
				part2_phost_taxid,
				part2_exp_preps,
				part2_feats = paste(part2_feat1_col,part2_feat2_col,sep="|"),
				part3_alias,
				part3_alias_type,
				part3_alias_type_mi,
				part3_id,
				part3_id_db,
				part3_id_db_mi,
				part3_xref_ac,
				part3_xref_db,
				part3_xref_db_mi,
				part3_xrefs = paste(part3_xref2_col,part3_xref3_col,part3_scixref_col,part3_scixref2_col,sep="|"),
				part3_comment1,
				part3_comment1_type,
				part3_comment1_type_mi,
				part3_taxid,
				part3_type,
				part3_type_mi,
				part3_pdm,
				part3_pdm_mi,
				part3_tissue_ac,
				part3_ct_ac,
				part3_phost_db,
				part3_phost_dbmi,
				part3_phost_taxid,
				part3_exp_preps,
				part3_feats = paste(part3_feat1_col,part3_feat2_col,sep="|"),
				part4_alias,
				part4_alias_type,
				part4_alias_type_mi,
				part4_id,
				part4_id_db,
				part4_id_db_mi,
				part4_xref_ac,
				part4_xref_db,
				part4_xref_db_mi,
				part4_xrefs = paste(part4_xref2_col,part4_xref3_col,part4_scixref_col,part4_scixref2_col,sep="|"),
				part4_comment1,
				part4_comment1_type,
				part4_comment1_type_mi,
				part4_taxid,
				part4_type,
				part4_type_mi,
				part4_pdm,
				part4_pdm_mi,
				part4_tissue_ac,
				part4_ct_ac,
				part4_phost_db,
				part4_phost_dbmi,
				part4_phost_taxid,
				part4_exp_preps,
				part4_feats = paste(part4_feat1_col,part4_feat2_col,sep="|"),
				part5_alias,
				part5_alias_type,
				part5_alias_type_mi,
				part5_id,
				part5_id_db,
				part5_id_db_mi,
				part5_xref_ac,
				part5_xref_db,
				part5_xref_db_mi,
				part5_xrefs = paste(part5_xref2_col,part5_xref3_col,part5_scixref_col,part5_scixref2_col,sep="|"),
				part5_comment1,
				part5_comment1_type,
				part5_comment1_type_mi,
				part5_taxid,
				part5_type,
				part5_type_mi,
				part5_pdm,
				part5_pdm_mi,
				part5_tissue_ac,
				part5_ct_ac,
				part5_phost_db,
				part5_phost_dbmi,
				part5_phost_taxid,
				part5_exp_preps,
				part5_feats = paste(part5_feat1_col,part5_feat2_col,sep="|"),
				fig_leg,
			fig_leg_type,
			fig_leg_type_mi,
			comment_int1,
			comment_int1_type,
			comment_int1_type_mi,
			comment_int2,
			comment_int2_type,
			comment_int2_type_mi,
			comment_int3,
			comment_int3_type,
			comment_int3_type_mi,
			comment_int4,
			comment_int4_type,
			comment_int4_type_mi,
			Date),
			by = "xref_int1"])

for (col in colnames(preflatfile4)) preflatfile4[grepl("^\\|+$",get(col)), (col) := ""]
for (col in colnames(preflatfile4)) preflatfile4[grepl("\\|\\|",get(col)), (col) := ""]
for (col in colnames(preflatfile4)) preflatfile4[grepl("^\\|+",get(col)), (col) := ""]


preflatfile5 <- preflatfile4[,.(psimi,
				psi_mi_mi,
				identity,
				identity_mi,
				comment_publ,
				comment_publ_type,
				comment_publ_type_mi,
				xref_exp1,
				xref_exp1_db,
				xref_exp1_db_mi,
				xrefs_exp = gsub("^\\||\\|$","",xrefs_exp),
				pmid,
				pubmed_ref,
				pubmed_ref_mi,
				primary_ref,
				primary_ref_mi,
				host_taxid,
				tissue_ac,
				ct_ac,
				int_det_met,
				int_det_met_mi,
				xref_int1,
				xref_int1_db,
				xref_int1_db_mi,
				xrefs_int = gsub("^\\||\\|$","",xrefs_int),
				part1 = paste(part1_alias,part1_alias_type,part1_alias_type_mi,part1_id,part1_id_db,part1_id_db_mi,part1_xref_ac,part1_xref_db,part1_xref_db_mi,gsub("^\\||\\|$","",part1_xrefs),part1_comment1,part1_comment1_type,part1_comment1_type_mi,part1_taxid,part1_type,part1_type_mi,part1_pdm,part1_pdm_mi,part1_tissue_ac,part1_ct_ac,part1_phost_db,part1_phost_dbmi,part1_phost_taxid,part1_exp_preps,gsub("\\|+","\\|",part1_feats),sep="£"),
				part2 = paste(part2_alias,part2_alias_type,part2_alias_type_mi,part2_id,part2_id_db,part2_id_db_mi,part2_xref1,part2_xref1_db,part2_xref1_db_mi,gsub("^\\||\\|$","",part2_xrefs),part2_comment1,part2_comment1_type,part2_comment1_type_mi,part2_taxid,part2_type,part2_type_mi,part2_pdm,part2_pdm_mi,part2_tissue_ac,part2_ct_ac,part2_phost_db,part2_phost_dbmi,part2_phost_taxid,part2_exp_preps,gsub("\\|+","\\|",part2_feats),sep="£"),
				part3 = ifelse(part3_alias!="",
				               paste(part3_alias,part3_alias_type,part3_alias_type_mi,part3_id,part3_id_db,part3_id_db_mi,part3_xref_ac,part3_xref_db,part3_xref_db_mi,gsub("^\\||\\|$","",part3_xrefs),part3_comment1,part3_comment1_type,part3_comment1_type_mi,part3_taxid,part3_type,part3_type_mi,part3_pdm,part3_pdm_mi,part3_tissue_ac,part3_ct_ac,part3_phost_db,part3_phost_dbmi,part3_phost_taxid,part3_exp_preps,gsub("\\|+","\\|",part3_feats),sep="£"),
				               ""),
				part4 = ifelse(part4_alias!="",
				               paste(part4_alias,part4_alias_type,part4_alias_type_mi,part4_id,part4_id_db,part4_id_db_mi,part4_xref_ac,part4_xref_db,part4_xref_db_mi,gsub("^\\||\\|$","",part4_xrefs),part4_comment1,part4_comment1_type,part4_comment1_type_mi,part4_taxid,part4_type,part4_type_mi,part4_pdm,part4_pdm_mi,part4_tissue_ac,part4_ct_ac,part4_phost_db,part4_phost_dbmi,part4_phost_taxid,part4_exp_preps,gsub("\\|+","\\|",part4_feats),sep="£"),
				               ""),
				part5 = ifelse(part5_alias!="",
				               paste(part5_alias,part5_alias_type,part5_alias_type_mi,part5_id,part5_id_db,part5_id_db_mi,part5_xref_ac,part5_xref_db,part5_xref_db_mi,gsub("^\\||\\|$","",part5_xrefs),part5_comment1,part5_comment1_type,part5_comment1_type_mi,part5_taxid,part5_type,part5_type_mi,part5_pdm,part5_pdm_mi,part5_tissue_ac,part5_ct_ac,part5_phost_db,part5_phost_dbmi,part5_phost_taxid,part5_exp_preps,gsub("\\|+","\\|",part5_feats),sep="£"),
				               ""),
			fig_leg,
			fig_leg_type,
			fig_leg_type_mi,
			comment_int1,
			comment_int1_type,
			comment_int1_type_mi,
			comment_int2,
			comment_int2_type,
			comment_int2_type_mi,
			comment_int3,
			comment_int3_type,
			comment_int3_type_mi,
			comment_int4,
			comment_int4_type,
			comment_int4_type_mi,
			Date)]


flatfile <- unique(preflatfile5[,.(psimi,
			psi_mi_mi,
			identity,
			identity_mi,
			comment_publ,
			comment_publ_type,
			comment_publ_type_mi,
			xref_exp1,
			xref_exp1_db,
			xref_exp1_db_mi,
			xrefs_exp,
			pmid,
			pubmed_ref,
			pubmed_ref_mi,
			primary_ref,
			primary_ref_mi,
			host_taxid,
			tissue_ac,
			ct_ac,
			int_det_met,
			int_det_met_mi,
			xref_int1,
			xref_int1_db,
			xref_int1_db_mi,
			xrefs_int,
			parts = paste(gsub("\\|+","\\|",part1),gsub("\\|+","\\|",part2),gsub("\\|+","\\|",part3),gsub("\\|+","\\|",part4),gsub("\\|+","\\|",part5),sep=";"),
			fig_leg,
			fig_leg_type,
			fig_leg_type_mi,
			comment_int1,
			comment_int1_type,
			comment_int1_type_mi,
			comment_int2,
			comment_int2_type,
			comment_int2_type_mi,
			comment_int3,
			comment_int3_type,
			comment_int3_type_mi,
			comment_int4,
			comment_int4_type,
			comment_int4_type_mi,
			comment_int4_db = "intact",
			comment_int4_db_mi = "MI:0469",
			Date,
			int.type = ifelse(
			        part3 == "" &
			                grepl("purified",part1) &
			                grepl("purified",part2),
			        "direct interaction", 
			        "physical association" 
			),
			int.type.mi = ifelse(
			        part3 == "" &
			                grepl("purified",part1) &
			                grepl("purified",part2),
			        "MI:0407",
			        "MI:0915"
			),
			pdm = "experimental particp",
			pdm.mi = "MI:0661")])

fwrite(flatfile,"./xml_import/scicura_map.txt",col.names = T,row.names = F,sep="\t",quote = F)
```

## Pending issues

   1. Participant experimental and biological roles are set to unspecified. Experimental role at least can probably be provided.
   2. Participant detection method is associated to each participant exclusively, but not provided at experiment level. I have set the experiment level to the generic 'experimental detection' and the specifics will be given at the participant level. 
   3. Some interaction detection methods (experimental detection in SciCura) have no participant detection method specified. These have been set to unspecified, but it would be great to have them.
   4. Records with non-mapped cell lines have not been included.
   5. Records with unidentified TGs have also been ignored.
   6. Interaction types are missing. They have been set using a rather simplistic algorithm and might need revising. At the moment, all interaction types are set to physical association.
   7. NTNU MI term will be updated. The term might need replacement with a new SciCura term later on (because of xrefs), but not for the moment.

   
### Check for interaction type
```{r int.type.check}
int.type.check <- unique(flatfile[,.(
        purif.parts <- ifelse(
                grepl("purified",parts),
                "yes",
                "no"
        ),
        int_det_met,
        int_det_met_mi,
        int.type,
        int.type.mi
)])
```

### Publications list for easy checks
```{r publ.list}
pmids <- unique(flatfile[,.(pmid)])
```

### Test file
```{r test.file}
set.seed(88)
test.flatfile <- flatfile[sample(1:nrow(flatfile),1)]
fwrite(
        test.flatfile,
        "./xml_import/test.flatfile.txt",
        col.names = T,
        row.names = F,
        sep = "\t",
        quote = F
)
```

### Import issues

    1. Remark internal annotations need to be remapped: a new 'remark-internal-1' term is created and needs to be merged with the proper CV term at the database level. 
    2. Participant detection methods are not imported. PDM at interaction level is pre-defined and fine.  
    3. There is an issue where in some cases participant host is imported, but the drop-down menu in the editor appears empty. I tried solving it by leaving the participant host shortlabel field empty (even though XML maker shows it at red). This works for some cases, but not all. Last attempt to fix it involves separating tissue and cell type acs and ignoring the short label. 
 
    
In one of the import attempts, The import got interrupted at interaction 152 (PMID:10995766) for unknown reasons. I tried importing a version of the file using just the interactions after line 152 (included), but it also failed (see files sci_10.1_3011.xml for the xml to import and scicura_map_missing.txt for the flatfile). I also tried removing only line 152 and importing the remaining lines, but it failed again (see files sci_10.2_3011.xml for the xml to import and scicura_map_missing.2.txt for the flatfile). Version sci_11_3011.xml could import the whole thing, though, so this is no longer an issue. 
    

    